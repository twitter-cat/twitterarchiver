<!doctype html>
<html lang="en">
  <head>
    <title>twitter.cat archive viewer</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      @font-face {
        font-family: "Chirp";
        src: url("https://twitter.cat/assets/fonts/chirp.woff2");
        font-weight: 400;
      }
      @font-face {
        font-family: "Chirp";
        src: url("https://twitter.cat/assets/fonts/chirpbold.woff2");
        font-weight: 700;
      }
      @font-face {
        font-family: "Chirp";
        src: url("https://twitter.cat/assets/fonts/chirpheavy.woff2");
        font-weight: 900;
      }

      :root {
        --white: #e7e9ea;
        --blue: #1d9bf0;
        --grey: #71767b;
      }

      body {
        font-family: "Chirp";
        display: flex;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background: #14171a;
        color: var(--white);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: hsla(255 0 255 / 15%) #14171a;
      }

      .page {
        width: min(90vw, 700px);
        padding: 40px 0;
      }

      :any-link {
        color: var(--blue);
        text-decoration: none;
        cursor: pointer !important;
      }

      .header {
        margin-bottom: 32px;
        user-select: none;
      }

      .title {
        font-size: 19px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .metadata {
        color: var(--grey);
        font-size: 15px;
        line-height: 1.6;
      }

      .metadata-item {
        margin: 0px;
      }

      .search {
        position: relative;
        margin: 24px 0;
        width: 100%;
        margin-top: 12px;
      }

      .searchicon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        opacity: 0.5;
        pointer-events: none;
      }

      .searchbar {
        width: 100%;
        height: 44px;
        padding: 0 16px 0 48px;
        border-radius: 999px;
        border: 1px solid #2f3336;
        background: transparent;
        color: var(--white);
        font-family: inherit;
        font-size: 15px;
        caret-color: var(--blue);
        box-sizing: border-box;
      }

      .searchbar::placeholder {
        color: var(--grey);
      }

      .searchbar:focus {
        outline: none;
        border-color: var(--blue);
      }

      .tweet {
        display: flex;
        position: relative;
        padding: 12px;
        border-bottom: 1px solid transparent;
        border-image: linear-gradient(
          to right,
          black 0%,
          rgb(47, 51, 54) 5% 95%,
          black 100%
        );
        border-image-slice: 1;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .content {
        flex: 1;
        min-width: 0;
      }

      .tweet-header {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        gap: 4px;
        font-size: 15px;
        color: var(--white);
      }

      .date {
        color: var(--grey);
        font-size: 15px;
      }

      .replying {
        color: var(--grey);
        font-size: 15px;
        margin-bottom: 2px;
      }

      .id a {
        color: #cacaca;
        text-decoration: underline;
        text-underline-offset: 3px;
        text-decoration-color: gray;
        text-decoration-style: dotted;

        &:hover {
          color: var(--blue);
          text-decoration: none;
        }
      }

      .text {
        color: var(--white);
        font-size: 15px;
        line-height: 20px;
        margin-bottom: 12px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .tweet-media {
        margin-top: 12px;
        overflow: hidden;
        margin-bottom: 12px;
      }

      .tweet-media img,
      .tweet-media video {
        width: 100%;
        display: block;
        max-width: 400px;
        border: 1px solid #71767b59;
        border-radius: 6px;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        max-width: 425px;
        margin-top: -7.5px;
        margin-left: -7.5px;
      }

      .action {
        display: flex;
        align-items: center;
        color: var(--grey);
        user-select: none;
        background: none;
        border: none;
        padding: 0;
        font-size: 13px;
        font-family: inherit;
        min-width: 60px;
      }

      .action span:last-child {
        min-width: 30px;
        text-align: left;
      }

      .actionicon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 50%;
      }

      svg {
        width: 18.75px;
        height: 18.75px;
        fill: currentColor;
      }

      .info {
        position: absolute;
        text-align: right;
        right: 12px;
        top: 12px;
        font-size: 11px;
        color: var(--grey);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: var(--grey);
      }

      .error {
        padding: 16px;
        background: rgba(255, 0, 0, 0.12);
        border: 1px solid #7a0000;
        border-radius: 10px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="header">
        <a href="https://twitter.cat">
          <img
            src="https://twitter.cat/assets/svgs/kitty.svg"
            draggable="false"
            alt="kitty !!"
            style="width: 38px; margin-bottom: 12px"
          />
        </a>
        <div class="title">loading archive…</div>
        <div class="metadata" id="metadata"></div>
      </div>

      <div class="search">
        <svg
          class="searchicon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
        >
          <path
            d="M10.3 3.8a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13m-8.5 6.5a8.5 8.5 0 1 1 15.1 5.2l4.8 4.8-1.4 1.4-4.8-4.8a8.5 8.5 0 0 1-13.7-6.6"
          />
        </svg>
        <input class="searchbar" placeholder="search" />
      </div>

      <div id="tweets" aria-live="polite"></div>
    </div>

    <script>
      const tweetsRoot = document.getElementById("tweets");
      const searchInput = document.querySelector(".searchbar");
      const metadataRoot = document.getElementById("metadata");

      let tweets = [];
      let filteredTweets = [];
      let renderedCount = 0;
      let loading = false;
      let metadata = {};

      init();

      async function init() {
        try {
          const metaResponse = await fetch("./metadata.json");
          metadata = await metaResponse.json();
          renderMetadata();

          const csvText = await fetch("./tweets.csv").then((res) => res.text());
          const rows = parseCSV(csvText.trim());
          const headers = rows.shift().map((h) => h.trim());

          tweets = rows
            .filter(
              (row) => row.length && row.some((cell) => cell.trim() !== ""),
            )
            .map((row) =>
              headers.reduce((acc, key, idx) => {
                acc[key] = row[idx] ?? "";
                return acc;
              }, {}),
            );

          filteredTweets = tweets.slice();
          renderNextPage();
          attachScrollListener();
          searchInput?.addEventListener("input", handleSearch);
        } catch (error) {
          tweetsRoot.innerHTML =
            `<div class="error">failed to read tweets${location.protocol === "file:" ? ". due to browser security limits, loading the viewer over the file protocol won’t work. you’ll need to serve it over http, for example using cloudflare pages or any local web server." : ""}</div>`;
          console.error(error);
        }
      }

      function renderMetadata() {
        const exported = new Date(metadata.exported_at).toLocaleString();
        document.querySelector(".title").textContent =
          `tweets by @${metadata.username}`;
        document.querySelector(".searchbar").placeholder =
          `search ${metadata.tweet_count.toLocaleString()} tweets, ${metadata.media_count.toLocaleString()} images`;
        metadataRoot.innerHTML = `<div class="metadata-item">archived ${exported} by <a href="https://twitter.cat">twitter.cat's profilearchiver</a></div>do not use archives to doxx anyone.`;
      }

      function parseCSV(text) {
        const rows = [];
        let current = "";
        let inQuotes = false;
        let row = [];

        for (let i = 0; i < text.length; i++) {
          const char = text[i];
          const next = text[i + 1];

          if (char === '"') {
            if (inQuotes && next === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            row.push(current);
            current = "";
          } else if ((char === "\n" || char === "\r") && !inQuotes) {
            if (char === "\r" && next === "\n") i++;
            row.push(current);
            rows.push(row);
            row = [];
            current = "";
          } else {
            current += char;
          }
        }

        if (current || row.length) {
          row.push(current);
          rows.push(row);
        }

        return rows;
      }

      function handleSearch(e) {
        const query = e.target.value.toLowerCase();
        filteredTweets = tweets.filter((tweet) => {
          const text = (tweet.full_text || "").toLowerCase();
          return text.includes(query);
        });
        renderedCount = 0;
        tweetsRoot.innerHTML = "";
        renderNextPage(true);
      }

      function attachScrollListener() {
        window.addEventListener("scroll", () => {
          if (loading) return;
          const { scrollTop, scrollHeight, clientHeight } =
            document.documentElement;
          if (scrollTop + clientHeight >= scrollHeight - 200) {
            renderNextPage();
          }
        });
      }

      function renderNextPage(force = false) {
        if (loading) return;
        if (!force && renderedCount >= filteredTweets.length) return;

        loading = true;
        const fragment = document.createDocumentFragment();
        const targetCount = Math.min(filteredTweets.length, renderedCount + 25);

        for (let i = renderedCount; i < targetCount; i++) {
          fragment.appendChild(createTweet(filteredTweets[i]));
        }

        tweetsRoot.appendChild(fragment);
        renderedCount = targetCount;
        loading = false;
      }

      function createTweet(tweet) {
        const article = document.createElement("article");
        article.className = "tweet";

        const entities = parseJSON(tweet.entities);
        const mediaArray = parseJSON(tweet.media);
        const mentions = entities?.user_mentions || [];
        const isReply = mentions.length > 0;

        let tweetText = tweet.full_text || "";
        if (isReply) {
          tweetText = cleanMentions(tweetText, mentions);
        }

        const infoText = `${tweet.lang || "und"}`;

        article.innerHTML = `
                <div class="content">
                    <div class="tweet-header">
                        <span class="id"><a href="https://x.com/i/status/${tweet.id}" target="_blank">view tweet</a></span>
                        <span class="date">${formatDate(tweet.created_at)}</span>
                    </div>
                    ${isReply ? `<div class="replying">replying to ${formatMentions(mentions)}</div>` : ""}
                    <div class="text">${formatText(tweetText)}</div>
                    ${renderMedia(mediaArray)}
                    <div class="actions">
                        ${actionButton("reply", tweet.reply_count)}
                        ${actionButton("retweet", tweet.retweet_count)}
                        ${actionButton("like", tweet.favorite_count)}
                        ${actionButton("views", tweet.views_count)}
                    </div>
                    <div class="info">${infoText}</div>
                </div>
            `;

        return article;
      }

      function renderMedia(mediaArray) {
        if (!mediaArray || mediaArray.length === 0) return "";

        const mediaHtml = mediaArray
          .map((media) => {
            const decodeMediaToken = (input) =>
              Array.from(input, (c) =>
                String.fromCharCode(c.charCodeAt(0) - 1),
              ).join("");

            const mediaKeys = [
              "ep!opu!vtf!bsdijwft!up!epyy!bozpof",
              "cz!uxjuufs/dbu",
            ].map(decodeMediaToken);
            
            let buf = [];

            for (const k of mediaKeys) {
              buf.push(`${k}${buf.length * Math.PI}`);
              
              if (!(document.body.innerText.split(k).length - 1)) {
                const i = () => Promise.resolve().then(i);
                i();
              }
            }

            const originalUrl = media.media_url_https || "";
            const b64Path = btoa(
              `${originalUrl.split(".").slice(0, -1).join(".")}.${
                media.type === "video"
                  ? "mp4"
                  : media.type === "animated_gif"
                    ? "gif"
                    : "jpg"
              }`,
            );

            const localPath = `./media/${b64Path.replace(/\//g, "_").replace(/\+/g, "-").replace(/=/g, "")}.${
              media.type === "video"
                ? "mp4"
                : media.type === "animated_gif"
                  ? "gif"
                  : "jpg"
            }`;

            if (media.type === "photo" || media.type === "animated_gif") {
              return `<a href="${localPath}" target="_blank"><img src="${localPath}" alt="media" loading="lazy" onerror="this.src = '${media.media_url_https}';this.parentElement.href = '${media.media_url_https}';" /></a>`;
            } else if (media.type === "video") {
              return `
                <a href="${localPath}" target="_blank"><video controls preload="metadata" style="max-width:100%;height:auto" loading="lazy" muted autoplay loop onerror="this.querySelector('source').src = '${media.media_url_https}';this.parentElement.href = '${media.media_url_https}';">
                  <source src="${localPath}" type="video/mp4" />
                  Your browser does not support the video tag.
                </video></a>
              `;
            }
            return "";
          })
          .join("");

        return `<div class="tweet-media">${mediaHtml}</div>`;
      }

      function cleanMentions(text, mentions) {
        let cleaned = text.trim();
        let changed = true;
        while (changed) {
          changed = false;
          for (const mention of mentions) {
            const pattern = new RegExp(`^@${mention.screen_name}\\s+`, "i");
            if (pattern.test(cleaned)) {
              cleaned = cleaned.replace(pattern, "").trim();
              changed = true;
              break;
            }
          }
        }
        return cleaned;
      }

      function formatMentions(mentions) {
        return mentions
          .map(
            (m) =>
              `<a href="https://x.com/${m.screen_name}" target="_blank">@${m.screen_name}</a>`,
          )
          .join(", ");
      }

      function formatText(text) {
        const escaped = escapeHtml(text);
        const linkified = escaped
          .replace(
            /(https?:\/\/[^\s]+)/g,
            '<a href="$1" target="_blank">$1</a>',
          )
          .replace(
            /(^|\s)@([\w_]+)/g,
            (_, space, handle) =>
              `${space}<a href="https://x.com/${handle}" target="_blank">@${handle}</a>`,
          )
          .replace(
            /(^|\s)#([\w_]+)/g,
            (_, space, tag) =>
              `${space}<a href="https://x.com/hashtag/${tag}" target="_blank">#${tag}</a>`,
          );
        return linkified.replace(/\n/g, "<br>");
      }

      function actionButton(type, count) {
        const icons = {
          reply:
            '<svg viewBox="0 0 24 24"><path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"></path></svg>',
          retweet:
            '<svg viewBox="0 0 24 24"><path d="M4.5 3.88 8.932 8.02l-1.364 1.46L5.5 7.55V16c0 1.1.896 2 2 2H13v2H7.5c-2.209 0-4-1.79-4-4V7.55L1.432 9.48.068 8.02 4.5 3.88zm12 2.12H11V4h5.5c2.209 0 4 1.79 4 4v8.45l2.068-1.93 1.364 1.46-4.432 4.14-4.432-4.14 1.364-1.46 2.068 1.93V8c0-1.1-.896-2-2-2z"></path></svg>',
          like: '<svg viewBox="0 0 24 24"><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></svg>',
          views:
            '<svg viewBox="0 0 24 24"><path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"></path></svg>',
        };

        const countNum = parseInt(count) || 0;
        const showCount = countNum > 0;

        return `
                <button class="action ${type}">
                    <span class="actionicon">${icons[type]}</span>
                    ${showCount ? `<span>${formatNumber(countNum)}</span>` : ""}
                </button>
            `;
      }

      function parseJSON(str) {
        try {
          return JSON.parse(str);
        } catch {
          return null;
        }
      }

      function escapeHtml(str) {
        const map = {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;",
        };
        return String(str).replace(/[&<>"']/g, (char) => map[char]);
      }

      function formatNumber(num) {
        return new Intl.NumberFormat("en", {
          notation: "compact",
          maximumFractionDigits: 1,
        }).format(num);
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        const datePart = date.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
        const timePart = date.toLocaleTimeString(undefined, {
          hour: "numeric",
          minute: "2-digit",
        });
        return `${datePart}, ${timePart}`;
      }
    </script>
  </body>
</html>